<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

		<script type="text/javascript" src="gl-matrix.js"></script>
		<script type="text/javascript" src="litegl.js"></script>

		<script type="text/javascript" src="GameObject.js"></script>
		<script type="text/javascript" src="Transform.js"></script>
		<script type="text/javascript" src="Renderer.js"></script>
		<script type="text/javascript" src="Camera.js"></script>
		<script type="text/javascript" src="Light.js"></script>
		<script type="text/javascript" src="Scene.js"></script>

		<style type="text/css">
		body {
			display: block;
			margin: 0;
		}
		canvas{
			width: 100%;
			height: 100%;
		}

		</style>
		<script type="text/javascript">
					
			function KeyController(front,right){
				this.name = "keycontroller"
				this.front = front 	|| [0,0,1];
				this.right = right 	|| [1,0,0];
				this.speed = 50;
				//KeyController.prototype.onkeydown = function(){}
				KeyController.prototype.update = function(dt){
					if (gl.keys[87])  //W
						this.owner.transform.translateLocal(vec3.scale(vec3.create(),this.front,this.speed*dt));
					if (gl.keys[83])  //S
						this.owner.transform.translateLocal(vec3.scale(vec3.create(),this.front,-this.speed*dt));
					if (gl.keys[65])  //A
						this.owner.transform.translateLocal(vec3.scale(vec3.create(),this.right,this.speed*dt));
					if (gl.keys[68])  //D
						this.owner.transform.translateLocal(vec3.scale(vec3.create(),this.right,-this.speed*dt));
					
				}
			}

			function MouseController(horizontalMouseMoveToRotateVector,verticalMouseMoveToRotateVector){
				this.name = "mousecontroller"
				this.click_time = 0;
				this.h = horizontalMouseMoveToRotateVector 	|| [0,1,0];
				this.v = verticalMouseMoveToRotateVector 	|| [1,0,0];
				this.dx = 0;
				this.dy = 0;
				this.speed = 10;

				MouseController.prototype.onmousemove = function(e){
					var evento = e['evento'];
					if(evento.dragging){
						this.dx = evento.deltax;
						this.dy = evento.deltay;
					}
				}

				MouseController.prototype.update = function(dt){
					if (this.dx)
						this.owner.transform.rotate     (this.dx*dt*this.speed,this.h);
					if (this.dy)
						this.owner.transform.rotateLocal(this.dy*dt*this.speed,this.v);
					this.dx = 0;
					this.dy = 0;

				}
			}
				
			function init(){
				//create the rendering context
				var canvas = document.getElementById("content");
				var gl = GL.create({width:canvas.clientWidth,height:canvas.clientHeight});
				canvas.appendChild(gl.canvas);
				gl.animate();
				
				
				var obj = new GameObject("terrain");
				var ren = new Renderer();
				ren.mesh = GL.Mesh.fromURL("assets/terrain/terrain.ASE");
				ren.shader = GL.Shader.fromURL("light.vert","light.frag");;
				ren.texture = GL.Texture.fromURL("assets/terrain/terrain.png");
				obj.addComponent(ren);
				Scene.addObject(obj);
		

				var obj = new GameObject("player");
				obj.transform.position = [0,40,100];
				var ren = new Renderer();
				obj.addComponent(ren);
				//obj.transform.lookAt([0,0,0],[0,0,1],[0,1,0]);
				ren.mesh = GL.Mesh.fromURL("assets/x3_fighter/x3_fighter.ase");
				ren.shader = GL.Shader.fromURL("light.vert","light.frag");
				ren.texture = GL.Texture.fromURL("assets/x3_fighter/x3_fighter.png",{temp_color:[80,120,40,255], minFilter: gl.LINEAR_MIPMAP_LINEAR});
				Scene.addObject(obj);
							
				
				obj = new GameObject("camera");
				var cam = new Camera();
				obj.addComponent(cam);
				cam.lookAt([0,100,50],[0,40,0],[0,-1,0]);
				cam.setPerspective(45 * DEG2RAD,gl.canvas.width/gl.canvas.height,1,5000);
				Scene.addCamera(cam);
				var kc = new KeyController([0,0,-1],[-1,0,0]);
				obj.addComponent(kc);
				var mc = new MouseController([0,-1,0],[-1,0,0]);
				obj.addComponent(mc);
				Scene.addObject(obj);


				var ol1 = new GameObject("lightLeft");
				var l1 = new Light();
				l1.type = 2;
				ol1.addComponent(l1);
				l1.lookAt([-70,60,0],[-70,0,0],[0,0,1]);
				l1.spotAngle = 30;
				l1.spotExponent = 8;
				l1.range = 100;
				l1.intensity = 2;				
				Scene.addLight(l1);
				Scene.addObject(ol1);

				var ol2 = new GameObject("lightRight");
				var l2 = new Light();
				l2.type = 1;
				ol2.addComponent(l2);
				ol2.parent = Scene.objects[1];
				ol2.transform.updateModel();
				// l2.lookAt([0,60,0],[70,0,0],[0,0,1]);
				l2.spotAngle = 10;
				l2.range = 100;
				l2.intensity = 2;
				Scene.addLight(l2);
				Scene.addObject(ol2);
				
				Scene.ambientLight = [0.5,0.5,0.5,1];
				console.log(Scene.objects);

				
				//generic gl flags and settings
				gl.clearColor(0.01,0.01,0.01,1);
				gl.enable( gl.DEPTH_TEST );
				gl.enable( gl.CULL_FACE );

				//rendering loop
				gl.ondraw = function(){
					Scene.draw();
				}
		
				//update loop
				gl.onupdate = function(dt){
					Scene.update(dt);
				}

				gl.captureMouse();
				gl.captureKeys(true);

				//controllers
/*				gl.onmousedown 	= function(e){
					Scene.onmousedown(e);
				}
				gl.onmouseup 	= function(e){
					Scene.onmouseup(e);
				}
*/				gl.onkeydown 	= function(e){
					Scene.onkeydown(e);
				}
				gl.onmousemove 	= function(e){
					Scene.onmousemove(e);
				}


			}
		</script>
	</head>
	<body>
		<div id="content"></div>
		<script>init();</script>
	
	
	
	</body>
</html>