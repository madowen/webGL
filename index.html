<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

		<script type="text/javascript" src="gl-matrix.js"></script>
		<script type="text/javascript" src="litegl.js"></script>

		<script type="text/javascript" src="GameObject.js"></script>
		<script type="text/javascript" src="Transform.js"></script>
		<script type="text/javascript" src="Renderer.js"></script>
		<script type="text/javascript" src="Camera.js"></script>
		<script type="text/javascript" src="Light.js"></script>
		<script type="text/javascript" src="Scene.js"></script>
		<script type="text/javascript" src="MicroShaderManager.js"></script>
		<script type="text/javascript" src="jquery-2.1.3.min.js"></script>
		<script type="text/javascript" src="dat.gui.js"></script>

		<style type="text/css">
		body {
			display: block;
			margin: 0;
		}
		canvas{
			width: 100%;
			height: 100%;
		}

		</style>
		<script type="text/javascript">
			var scene = new Scene();
			// THIS SHOULD BE PROGRAMMED 
			function KeyController(front,right){
				this.name = "keycontroller"
				this.front = front 	|| [0,0,1];
				this.right = right 	|| [1,0,0];
				this.speed = 50;
				//KeyController.prototype.onkeydown = function(){}
				KeyController.prototype.update = function(dt){
					if (gl.keys[87])  //W
						this.owner.transform.translate(vec3.negate(this.owner.transform.front,this.owner.transform.front));
					if (gl.keys[83])  //S
						this.owner.transform.translate(this.owner.transform.front);
					if (gl.keys[65])  //A
						this.owner.transform.translate(vec3.negate(this.owner.transform.right,this.owner.transform.right));
					if (gl.keys[68])  //D
						this.owner.transform.translate(this.owner.transform.right);
					
				}
			}

			function MouseController(horizontalMouseMoveToRotateVector,verticalMouseMoveToRotateVector){
				this.name = "mousecontroller"
				this.click_time = 0;
				this.h = horizontalMouseMoveToRotateVector 	|| [0,1,0];
				this.v = verticalMouseMoveToRotateVector 	|| [1,0,0];
				this.dx = 0;
				this.dy = 0;
				this.speed = 10;

				MouseController.prototype.onmousemove = function(e){
					var evento = e['evento'];
					if(evento.dragging){
						this.dx = evento.deltax;
						this.dy = evento.deltay;
					}
				}

				MouseController.prototype.update = function(dt){
					if (this.dx)
						this.owner.transform.rotateLocal(this.dx*dt*this.speed,this.h);
					if (this.dy)
						this.owner.transform.rotate(this.dy*dt*this.speed,this.v);
					this.dx = 0;
					this.dy = 0;

				}
			}

			function init(){
				MicroShaderManager.loadXML();
				//create the rendering context
				var canvas = document.getElementById("content");
				var gl = GL.create({width:window.innerWidth,height: window.innerHeight});
				canvas.appendChild(gl.canvas);
				gl.animate();
				
				var obj = new GameObject("terrain");
				obj.transform.position = [0,0,150]
				var ren = new Renderer();
				ren.mesh = GL.Mesh.cube();
				// ren.shader = GL.Shader.fromURL("light.vert","light.frag");;
				ren.texture = GL.Texture.fromURL("assets/white.png");
				obj.transform.scale = [400,0.01,400];
				obj.addComponent(ren);
				scene.addObject(obj);
		

				var obj = new GameObject("player");
				obj.transform.position = [0,40,300];
				var ren = new Renderer();
				obj.addComponent(ren);
				//obj.transform.lookAt([0,0,0],[0,0,1],[0,1,0]);
				ren.mesh = GL.Mesh.fromURL("assets/boy.obj");
				// ren.shader = GL.Shader.fromURL("light.vert","light.frag");
				ren.texture = GL.Texture.fromURL("",{temp_color:[80,120,40,255], minFilter: gl.LINEAR_MIPMAP_LINEAR});
				scene.addObject(obj);
							
				
				obj = new GameObject("camera");
				var cam = new Camera();
				obj.addComponent(cam);
				cam.lookAt([0,300,0],[0,40,300],[0,1,0]);
				cam.setPerspective(45 * DEG2RAD,gl.canvas.width/gl.canvas.height,1,10000);
				scene.addCamera(cam);
				var kc = new KeyController([0,0,-1],[-1,0,0]);
				obj.addComponent(kc);
				var mc = new MouseController([0,-1,0],[-1,0,0]);
				obj.addComponent(mc);
				scene.addObject(obj);


				var ol1 = new GameObject("lightLeft");
				var l1 = new Light();
				l1.type = 2;
				ol1.addComponent(l1);
				l1.lookAt([100,60,300],[50,0,200],[0,0,1]);
				l1.spotAngle = 10;
				l1.spotExponent = 8;
				l1.range = 300;
				l1.intensity = 1;
				l1.diffuse = [100,25,100,1];
				l1.specular = [10,250,10,1];
				scene.addLight(l1);
				scene.addObject(ol1);

				var ol2 = new GameObject("lightRight",[0,20,200]);
				var l2 = new Light();
				l2.type = 1;
				l2.range = 60;
				l2.intensity = 0.8;
				l2.diffuse = [25,51,220,1];
				l2.specular = [128,25,220,1];
				ol2.addComponent(l2);
				scene.addLight(l2);
				scene.addObject(ol2);
				
				var ol3 = new GameObject("globalLight",[20,20,0]);
				var l3 = new Light();
				ol3.addComponent(l3);
				l3.lookAt([700,600,0],[70,0,-300],[0,0,1]);
				l3.type = 0;
				l3.intensity = 0.7;
				l3.diffuse = [25,51,220,1];
				l3.specular = [128,25,220,1];
				scene.addLight(l3);
				scene.addObject(ol3);


				scene.ambientLight = [20,20,20,1];
				console.log(scene.objects);

				//generic gl flags and settings
				gl.clearColor(0.2,0.2,0.2,1);
				gl.enable( gl.DEPTH_TEST );
				gl.enable( gl.CULL_FACE );

				//rendering loop
				gl.ondraw = function(){
					scene.draw();
				};
		
				//update loop
				gl.onupdate = function(dt){
					scene.update(dt);
				};

				gl.captureMouse();
				gl.captureKeys(true);

				//controllers
				gl.onkeydown 	= function(e){
					scene.onkeydown(e);
				};
				gl.onmousemove 	= function(e){
					scene.onmousemove(e);
				};
				var gui = new dat.GUI();
				scene.GUI(gui);

			}

			function resize(){
				alert("resize");
			}
		</script>
	</head>
	<body>
		<div id="content" onresize="resize()"></div>
		<script>init();</script>
	
	
	
	</body>
</html>